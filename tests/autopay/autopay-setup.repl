(load "../governance/governance-setup.repl")
(env-data { "tellor-admin-keyset": { "keys": [ "tellor-keyset-public-key" ], "pred": "keys-all" }, "upgrade": false, "ns": "free" })
(env-sigs [{"key": "tellor-keyset-public-key", "caps": []}])
(env-chain-data {'block-time: (time "2022-12-21T21:26:41Z"), 'block-height: 1})

(begin-tx)
(load "../../query-data-storage.pact")
(load "../../autopay.pact")
(commit-tx)
(env-data {
    "ns": "free",
    "reporter1-keyset": { "keys": [ "reporter1-public-key" ], "pred": "keys-all" },
    "reporter2-keyset": { "keys": [ "reporter2-public-key" ], "pred": "keys-all" },
    "reporter3-keyset": { "keys": [ "reporter3-public-key" ], "pred": "keys-all" },
    "reporter4-keyset": { "keys": [ "reporter4-public-key" ], "pred": "keys-all" },
    "user-keyset": { "keys": [ "user-public-key" ], "pred": "keys-all" } })
  (env-sigs [
    {"key": "reporter1-keyset", "caps": [(coin.TRANSFER "reporter1-keyset" "autopay" 100.0), (coin.TRANSFER "reporter1-keyset" "tellorflex" 100.0)]},
    {"key": "reporter2-keyset", "caps": [(coin.TRANSFER "reporter2-keyset" "autopay" 100.0), (coin.TRANSFER "reporter2-keyset" "tellorflex" 100.0)]},
    {"key": "reporter3-keyset", "caps": [(coin.TRANSFER "reporter3-keyset" "autopay" 100.0), (coin.TRANSFER "reporter3-keyset" "tellorflex" 100.0)]},
    {"key": "reporter4-keyset", "caps": [(coin.TRANSFER "reporter4-keyset" "autopay" 100.0), (coin.TRANSFER "reporter4-keyset" "tellorflex" 100.0)]},
    {"key": "user-keyset", "caps": [(coin.TRANSFER "user-keyset" "autopay" 1000.0)]},
    {"key": "reporter1-public-key", "caps": []}, {"key": "reporter2-public-key", "caps": []}, {"key": "reporter3-public-key", "caps": []},
    {"key": "reporter4-public-key", "caps": []}, {"key": "user-public-key", "caps": []}])
(begin-tx)
(namespace (read-msg "ns"))
(autopay.constructor 10)
(expect "Fee should be 10" 10 (autopay.fee))
;  deposit staker for 4 reporters
(tellorflex.deposit-stake
    "reporter1-keyset"
    (describe-keyset "free.reporter1-keyset")
    (h.precision 100))
(tellorflex.deposit-stake
    "reporter2-keyset"
    (describe-keyset "free.reporter2-keyset")
    (h.precision 100))
(tellorflex.deposit-stake
    "reporter3-keyset"
    (describe-keyset "free.reporter3-keyset")
    (h.precision 100))
(tellorflex.deposit-stake
    "reporter4-keyset"
    (describe-keyset "free.reporter4-keyset")
    (h.precision 100))
(commit-tx)